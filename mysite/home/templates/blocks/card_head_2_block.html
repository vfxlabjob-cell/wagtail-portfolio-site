{% load wagtailcore_tags wagtailimages_tags %}

<div class="card-head-2-container" data-card-id="{{ value.video.id|default:0 }}">
    <!-- Ambient Light эффект -->
    <div class="card-head-2-ambient-light" id="ambient-light-{{ value.video.id|default:0 }}"></div>
    
    <!-- Единое видео с размытым фоном через CSS -->
    <div class="card-head-2-video-wrapper">
        <video 
            class="card-head-2-main-video" 
            controls 
            muted 
            loop 
            playsinline 
            preload="metadata"
            data-project-name="{{ value.project_name }}"
            id="video-{{ value.video.id|default:0 }}"
        >
            <source src="{{ value.video.file.url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Скрытый canvas для анализа цветов -->
        <canvas class="card-head-2-color-canvas" id="color-canvas-{{ value.video.id|default:0 }}" style="display: none;"></canvas>
    </div>
    
    <!-- Информационная панель проекта -->
    <div class="card-head-2-info-panel">
        {% if value.year %}
            <div class="info-item">
                <span class="info-label">Year:</span>
                <span class="info-value">{{ value.year }}</span>
            </div>
        {% endif %}
        
        {% if value.industry %}
            <div class="info-item">
                <span class="info-label">Industry:</span>
                <span class="info-value">{{ value.industry }}</span>
            </div>
        {% endif %}
        
        {% if value.client_name %}
            <div class="info-item">
                <span class="info-label">Client:</span>
                {% if value.client_url %}
                    <a href="{{ value.client_url }}" class="info-value info-link" target="_blank" rel="noopener">{{ value.client_name }}</a>
                {% else %}
                    <span class="info-value">{{ value.client_name }}</span>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('[data-card-id="{{ value.video.id|default:0 }}"]');
    if (!container) return;
    
    const video = container.querySelector('.card-head-2-main-video');
    const canvas = container.querySelector('.card-head-2-color-canvas');
    const ambientLight = container.querySelector('.card-head-2-ambient-light');
    
    if (!video || !canvas || !ambientLight) return;
    
    console.log('Инициализация Card Head 2 видео с Ambient Light...');
    
    // Настройка canvas для анализа цветов
    const ctx = canvas.getContext('2d');
    let colorAnalysisInterval;
    let isAnalyzing = false;
    
    // Переменные для плавного смешивания цветов
    let currentColors = {
        primary: [128, 128, 128],   // Текущие цвета (серый по умолчанию)
        secondary: [128, 128, 128],
        tertiary: [128, 128, 128]
    };
    const lerpSpeed = 0.1; // Скорость смешивания (0.1 = медленно, 0.3 = быстро)
    
    // История цветов для сглаживания
    const colorHistory = {
        primary: [],
        secondary: [],
        tertiary: []
    };
    const maxHistorySize = 5; // Хранить последние 5 цветов
    
    // Функция для извлечения доминирующих цветов из видео
    function extractDominantColors() {
        if (!video.videoWidth || !video.videoHeight) return null;
        
        // Устанавливаем размер canvas
        canvas.width = 64; // Маленький размер для быстрого анализа
        canvas.height = 36;
        
        // Рисуем кадр видео на canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Получаем данные пикселей
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Анализируем цвета
        const colorCounts = {};
        const sampleSize = 4; // Анализируем каждый 4-й пиксель для производительности
        
        for (let i = 0; i < data.length; i += sampleSize * 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // Пропускаем слишком темные и слишком светлые пиксели
            const brightness = (r + g + b) / 3;
            if (brightness < 30 || brightness > 225) continue;
            
            // Квантуем цвета для группировки похожих
            const quantizedR = Math.floor(r / 32) * 32;
            const quantizedG = Math.floor(g / 32) * 32;
            const quantizedB = Math.floor(b / 32) * 32;
            
            const colorKey = `${quantizedR},${quantizedG},${quantizedB}`;
            colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
        }
        
        // Находим доминирующие цвета
        const sortedColors = Object.entries(colorCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 3)
            .map(([color]) => color.split(',').map(Number));
        
        return sortedColors;
    }
    
    // Функция для плавного смешивания цветов (lerp)
    function lerpColor(current, target, t) {
        return [
            Math.round(current[0] + (target[0] - current[0]) * t),
            Math.round(current[1] + (target[1] - current[1]) * t),
            Math.round(current[2] + (target[2] - current[2]) * t)
        ];
    }
    
    // Функция для добавления цвета в историю
    function addColorToHistory(colorType, color) {
        colorHistory[colorType].push([...color]); // Копируем массив
        
        // Ограничиваем размер истории
        if (colorHistory[colorType].length > maxHistorySize) {
            colorHistory[colorType].shift(); // Удаляем самый старый цвет
        }
    }
    
    // Функция для усреднения цветов из истории
    function getAverageColor(colorType) {
        const history = colorHistory[colorType];
        if (history.length === 0) {
            return [128, 128, 128]; // Серый по умолчанию
        }
        
        // Суммируем все цвета
        const sum = [0, 0, 0];
        for (const color of history) {
            sum[0] += color[0];
            sum[1] += color[1];
            sum[2] += color[2];
        }
        
        // Возвращаем среднее значение
        return [
            Math.round(sum[0] / history.length),
            Math.round(sum[1] / history.length),
            Math.round(sum[2] / history.length)
        ];
    }
    
    // Функция для обновления ambient light с плавным смешиванием
    function updateAmbientLight(colors) {
        if (!colors || colors.length === 0) return;
        
        // Получаем новые цвета из видео
        const newPrimary = colors[0];
        const newSecondary = colors[1] || newPrimary;
        const newTertiary = colors[2] || newSecondary;
        
        // Добавляем новые цвета в историю
        addColorToHistory('primary', newPrimary);
        addColorToHistory('secondary', newSecondary);
        addColorToHistory('tertiary', newTertiary);
        
        // Получаем усредненные цвета из истории
        const averagedPrimary = getAverageColor('primary');
        const averagedSecondary = getAverageColor('secondary');
        const averagedTertiary = getAverageColor('tertiary');
        
        // Плавно смешиваем текущие цвета с усредненными
        currentColors.primary = lerpColor(currentColors.primary, averagedPrimary, lerpSpeed);
        currentColors.secondary = lerpColor(currentColors.secondary, averagedSecondary, lerpSpeed);
        currentColors.tertiary = lerpColor(currentColors.tertiary, averagedTertiary, lerpSpeed);
        
        // Создаем RGB строки
        const primaryRgb = `rgb(${currentColors.primary[0]}, ${currentColors.primary[1]}, ${currentColors.primary[2]})`;
        const secondaryRgb = `rgb(${currentColors.secondary[0]}, ${currentColors.secondary[1]}, ${currentColors.secondary[2]})`;
        const tertiaryRgb = `rgb(${currentColors.tertiary[0]}, ${currentColors.tertiary[1]}, ${currentColors.tertiary[2]})`;
        
        // Создаем радиальный градиент
        const gradient = `radial-gradient(ellipse at center, 
            ${primaryRgb} 0%, 
            ${secondaryRgb} 30%, 
            ${tertiaryRgb} 60%, 
            transparent 100%)`;
        
        ambientLight.style.background = gradient;
        ambientLight.classList.add('active');
    }
    
    // Функция для анализа цветов в реальном времени
    function analyzeColors() {
        if (isAnalyzing) return;
        isAnalyzing = true;
        
        const colors = extractDominantColors();
        if (colors) {
            updateAmbientLight(colors);
        }
        
        isAnalyzing = false;
    }
    
    // Автозапуск видео и запуск анализа цветов
    video.addEventListener('canplay', function() {
        video.play().then(() => {
            console.log('Card Head 2 видео запущено с Ambient Light');
            
            // Запускаем анализ цветов 10 раз в секунду (каждые 100ms)
            setTimeout(() => {
                colorAnalysisInterval = setInterval(() => {
                    if (!video.paused && !video.ended) {
                        analyzeColors();
                    }
                }, 100); // 10 раз в секунду
            }, 500);
            
        }).catch((error) => {
            console.warn('Не удалось запустить видео:', error);
        });
    });
    
    // Останавливаем анализ при паузе, но оставляем подсветку
    video.addEventListener('pause', function() {
        if (colorAnalysisInterval) {
            clearInterval(colorAnalysisInterval);
            colorAnalysisInterval = null;
        }
        // Убираем эту строку, чтобы подсветка оставалась включенной
        // ambientLight.classList.remove('active');
    });
    
    // Возобновляем анализ при воспроизведении
    video.addEventListener('play', function() {
        if (!colorAnalysisInterval) {
            colorAnalysisInterval = setInterval(() => {
                if (!video.paused && !video.ended) {
                    analyzeColors();
                }
            }, 100); // 10 раз в секунду
        }
    });
    
    // Очистка при завершении видео
    video.addEventListener('ended', function() {
        if (colorAnalysisInterval) {
            clearInterval(colorAnalysisInterval);
            colorAnalysisInterval = null;
        }
        ambientLight.classList.remove('active');
    });
    
    // Обновляем заголовок страницы
    const projectName = video.getAttribute('data-project-name');
    const projectHeading = document.getElementById('project-heading');
    if (projectHeading && projectName) {
        projectHeading.textContent = projectName;
    }
    
    // Очистка при удалении элемента
    container.addEventListener('beforeunload', function() {
        if (colorAnalysisInterval) {
            clearInterval(colorAnalysisInterval);
            colorAnalysisInterval = null;
        }
    });
});
</script>
